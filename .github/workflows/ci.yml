name: "ðŸš€ CI"
on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - '.github/**'
jobs:
  test:
    name: ðŸ§ª tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“š checkout
        uses: actions/checkout@v4
      - name: ðŸŸ£ setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "6.0.x"
      - name: ðŸ§ª run tests (with coverage)
        run: dotnet test JsonToWord.sln --configuration Release --collect:"XPlat Code Coverage" --settings coverlet.runsettings
      - name: ðŸ§° install reportgenerator
        run: dotnet tool install --global dotnet-reportgenerator-globaltool
      - name: ðŸ§¾ generate coverage html report
        run: |
          export PATH="$PATH:$HOME/.dotnet/tools"
          reportgenerator -reports:"**/coverage.cobertura.xml" -targetdir:"coverage-report" -reporttypes:"Html"
      - name: âœ… enforce coverage (line-rate >= 80%)
        run: |
          python3 - <<'PY'
          import glob
          import os
          import xml.etree.ElementTree as ET
          
          matches = glob.glob(os.path.join("**", "coverage.cobertura.xml"), recursive=True)
          if not matches:
              raise SystemExit("coverage.cobertura.xml not found")
          
          report_path = max(matches, key=lambda p: os.path.getmtime(p))
          tree = ET.parse(report_path)
          root = tree.getroot()
          line_rate = root.attrib.get("line-rate")
          if line_rate is None:
              raise SystemExit("line-rate attribute missing in cobertura report")
          
          rate = float(line_rate)
          percent = rate * 100
          print(f"Coverage line-rate: {percent:.2f}% ({report_path})")
          
          if rate < 0.80:
              raise SystemExit(f"Coverage below threshold: {percent:.2f}% < 80.00%")
          PY
      - name: â¬†ï¸ upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dotnet-coverage
          path: TestResults
          if-no-files-found: ignore
      - name: â¬†ï¸ upload coverage html report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: coverage-report
          if-no-files-found: ignore

  release:
    name: ðŸš€ publish
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: ðŸ“š checkout
        uses: actions/checkout@v2
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: echo docker-id
        run: echo "::set-output name=docker-tag::0.0.$GITHUB_RUN_ID"
        id: docker-id
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v3
        with:
          images: elisradevops/docgen-json-to-word
          tags: |
            ${{steps.docker-id.outputs.docker-tag}}
      - name: Build and push
        uses: docker/build-push-action@v2
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
